import re
import time

import requests
from credentials import GITHUB_TOKEN


def get_file_commit(owner: str, repo: str, file_path: str = 'MLProject') -> int:
    """
    :param owner: e.g. apache
    :param repo: e.g. kafka
    :param file_path: e.g. in_repo_path_to_MLProject_file
    :return: count: int
    """
    res = requests.get(f'https://api.github.com/repos/{owner}/{repo}/commits?path={file_path}')
    return len(res.json())  # len = count of commits


def get_file_commit_creation(file_urls: list):
    dates = []
    print(len(file_urls))
    counter = 1

    for path in file_urls:
        # noinspection PyBroadException
        try:
            print(f'working on file url No: {counter}')
            counter += 1
            time.sleep(0.5)
            s = path.split('/')
            owner = s[3]
            repo = s[4]

            pattern = re.compile(r'blob/\b[0-9a-f]{40}\b/')
            result = re.sub(pattern, '', path)
            final_path = '/'.join(result.split('/')[5:])
            res = requests.get(f'https://api.github.com/repos/{owner}/{repo}/commits?path={final_path}',
                               headers={'Authorization': f'token {GITHUB_TOKEN}'}).json()
            # get the date of the very first commit on mlproject file
            print(res[-1])
            date = res[-1]['commit']['committer']['date'][:4]
            dates.append(date)
            #print(date)
        except Exception as e:
            print(e)
            pass
    return dates


def gen_creation_date(urls: [str]) -> str:  # year string generator
    """
    batch analysis, returns distribution of repo creation date

    :param urls:
    :return: [int]
    """

    for url in urls:
        s = url.split('/')
        owner = s[-2]
        repo = s[-1]
        res = requests.get(f'https://api.github.com/repos/{owner}/{repo}').json()
        yield res['created_at']


def get_creation_date_batch(urls: [str]) -> [str]:  # year string generator
    """
    batch analysis, returns distribution of repo creation date

    :param urls:
    :return: [int]
    """

    dates = []
    for url in urls:
        s = url.split('/')
        owner = s[-2]
        repo = s[-1]
        res = requests.get(f'https://api.github.com/repos/{owner}/{repo}',
                           headers={'Authorization': 'token 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'}).json()
        time.sleep(1)
        print(res)
        print(res['created_at'])
        dates.append(res['created_at'][:4])
    print(dates)

    return dates


if __name__ == '__main__':
    repo_owner = 'apache'
    repo_name = 'skywalking'
    # get_file_commit(owner=repo_owner, repo=repo_name, file_path="MLProject")
    # sample_data = []
    # c_date_generator = gen_creation_date(urls=sample_data)
    # print(next(c_date_generator))
    # print(get_creation_date_batch(urls=sample_data))

    distribution = ['2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021',
                    '2021', '2019', '2021', '2021', '2021', '2021', '2019', '2021', '2021', '2021', '2021', '2021',
                    '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021',
                    '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021',
                    '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021',
                    '2021', '2019', '2021', '2020', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021',
                    '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021',
                    '2021', '2021', '2020', '2020', '2021', '2020', '2020', '2020', '2020', '2020', '2020', '2020',
                    '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020',
                    '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020',
                    '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020',
                    '2020', '2019', '2019', '2018', '2019', '2019', '2019', '2017', '2019', '2019', '2019', '2019',
                    '2019', '2019', '2019', '2017', '2018', '2018', '2018', '2018', '2018', '2018', '2014', '2018',
                    '2018', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2018',
                    '2018', '2017', '2021', '2021', '2020', '2021', '2021', '2021', '2021', '2021', '2021', '2018',
                    '2021', '2021', '2021', '2019', '2020', '2021', '2021', '2021', '2021', '2021', '2021', '2021',
                    '2021', '2021']
    print(distribution.count('2017'))
    print(distribution.count('2018'))
    print(distribution.count('2019'))
    print(distribution.count('2020'))
    print(distribution.count('2021'))

    from sample_data import sample_flat_file_path
    print(len(sample_flat_file_path))

    file_distribution_dates = get_file_commit_creation(sample_flat_file_path)
    print(file_distribution_dates)

    print(file_distribution_dates.count('2017'))
    print(file_distribution_dates.count('2018'))
    print(file_distribution_dates.count('2019'))
    print(file_distribution_dates.count('2020'))
    print(file_distribution_dates.count('2021'))

    r = ['2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2020', '2020', '2021', '2021', '2021', '2021', '2019', '2021', '2021', '2021', '2021', '2018', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2020', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2019', '2018', '2021', '2021', '2021', '2021', '2020', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2020', '2020', '2021', '2021', '2021', '2021', '2018', '2021', '2018', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2020', '2020', '2021', '2020', '2019', '2019', '2021', '2021', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2019', '2020', '2020', '2019', '2019', '2019', '2019', '2019', '2018', '2019', '2018', '2018', '2019', '2018', '2019', '2019', '2019', '2019', '2019', '2019', '2020', '2020', '2020', '2020', '2019', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2019', '2019', '2020', '2019', '2019', '2019', '2019', '2019', '2019', '2019', '2018', '2018', '2018', '2019', '2019', '2019', '2019', '2019', '2019', '2018', '2019', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2020', '2019', '2019', '2019', '2020', '2019', '2019', '2020', '2020', '2019', '2019', '2019', '2019', '2019', '2019', '2019', '2019', '2019', '2019', '2019', '2019', '2019', '2019', '2019', '2020', '2018', '2018', '2018', '2018', '2018', '2018', '2018', '2018', '2018', '2018', '2018', '2018', '2018', '2019', '2019', '2018', '2019', '2018', '2018', '2018', '2018', '2018', '2018', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2019', '2021', '2020', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2020', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2019', '2019', '2019', '2019', '2019', '2019', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021', '2021']

